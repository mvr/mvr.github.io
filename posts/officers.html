<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Officers on the GPU</title>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous">
        <script defer src="../katex.js" crossorigin="anonymous"></script>
        <!-- <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script> -->

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            var mathElements = document.getElementsByClassName("math");
            for (var i = 0; i < mathElements.length; i++) {
              var texText = mathElements[i].firstChild;
              if (mathElements[i].tagName == "SPAN") {
                katex.render(texText.data, mathElements[i], {
                  displayMode: mathElements[i].classList.contains('display'),
                  throwOnError: false,
                  fleqn: false
                });
              }}});
        </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">

      <!-- TODO: Some other font candidates. Maybe Nunito? -->
      <!-- <link rel="preconnect" href="https://fonts.googleapis.com"> -->
      <!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> -->
      <!-- <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"> -->

        <link rel="stylesheet" type="text/css" href="../css/style.css" />

        <link rel="icon" type="image/png" href="../favicon.png" />

        <meta name="LifeViewer" content="lifeviewer textarea 30 hide limit">

        <link rel="alternate" type="application/atom+xml" title="mvr Blog Posts" href="../atom.xml" />
    </head>

    <body>
      <svg style="display: none;">
  <!-- Right Chevron -->
  <symbol id="icon-chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"></path>
  </symbol>

  <!-- Left Chevron -->
  <symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5l-7.5-7.5 7.5-7.5"></path>
  </symbol>
      </svg>
        <!-- <div id="header">
     <a href="/">&#171; Home</a>
     </div> -->

<section class="post">
    <a href="../" id="home-page-link"><svg class="chevron-icon"><use href="#icon-chevron-left"></use></svg> Home</a>
    <h1 class="post-title"><a href="../posts/officers.html">Officers on the GPU</a></h1>
<p class="post-deets">March  8, 2025   / <a title="All pages tagged 'code'." href="../tags/code.html" rel="tag">code</a>, <a title="All pages tagged 'cuda'." href="../tags/cuda.html" rel="tag">cuda</a>, <a title="All pages tagged 'officers'." href="../tags/officers.html" rel="tag">officers</a> </p>
<div class="post-content">
    <p>Officers is a two-player “take-and-break” game played with heaps of
coins (or if you prefer, piles of beans, or <a href="https://www.routledge.com/Winning-Ways-for-Your-Mathematical-Plays-Volume-1/Berlekamp-Conway-Guy/p/book/9781568811307">officers and their
subordinates</a>, or <a href="https://doi.org/10.2307/2589561">groups of people who form indivisible couples</a><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">In
the equivalent game Couples-are-Forever, a move is to choose a heap
and split it into two, with the proviso that you may not split a heap
of size 2. An Officers heap of size <span class="math inline">n</span> is equivalent to a
Couples-are-Forever heap of size <span class="math inline">n+1</span>.<br />
<br />
</span></span>, or …). The two players
alternate turns, and every turn consists of removing a coin from a
heap and leaving the remainder in either one or two heaps. In
particular, taking away a lone coin is not a valid move. The winner is
the last player who can make a move.</p>
<p>For example, a game starting with a single pile of <span class="math inline">10</span> coins might
proceed</p>
<p><span class="math display">
[10] 
\xrightarrow{\mathcal{L}} [3, 6] 
\xrightarrow{\mathcal{R}} [3, 1, 4]
\xrightarrow{\mathcal{L}} [1, 1, 1, 4]
\xrightarrow{\mathcal{R}} [1, 1, 1, 1, 2]
\xrightarrow{\mathcal{L}} [1, 1, 1, 1, 1]
</span></p>
<p>at which point player <span class="math inline">\mathcal{R}</span> is stuck, so player <span class="math inline">\mathcal{L}</span>
has won.<span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">In fact, he was following the winning strategy.<br />
<br />
</span></span> Although
the total number of coins decreases by 1 each turn, the outcome of the
game is not determined simply by the parity of the starting number of
coins: the moment that the game ends also depends on how many piles
are created by the players making splitting moves. As we will soon
see, the winning move from any given position is extremely
unpredictable.</p>
<p>We can solve a game of this kind by calculating the <em>Grundy value</em> for
each position, and in this post I’m going to discuss my attempt at
calculating these values for Officers as fast as possible.</p>
<!--more-->
<p>Officers is the only unsolved “single-digit octal game”,<span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Achim
Flammenkamp has the most up-to-date <a href="https://wwwhomes.uni-bielefeld.de/achim/octal.html">status page</a>, to the best of my
knowledge.<br />
<br />
</span></span> and like all finite octal games, its values are
conjectured to be eventually periodic. J. P. Grossman has calculated
140 trillion values, with no signs of periodicity yet! In the first
few sections I’ll recapitulate some of the strategies Grossman used,
before moving to the world of CUDA.</p>
<p>I’m a newcomer to GPU programming, so I would appreciate any comments
or ideas.</p>
<h2 id="spraguegrundy-theory">Sprague–Grundy Theory</h2>
<p>Here’s a very compressed outline of Sprague-Grundy theory, just what
we need to work on Officers.<span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">See the references for more details.<br />
<br />
</span></span></p>
<p>The <em>Grundy value</em> of an Officers position is the equivalent size of
heap in the game of <em>Nim</em>. This this value must exist thanks to the
Sprague–Grundy theorem, which states that every “impartial game” (both
players have the same options from any position) under the “normal
play convention” (a player who can’t make a move loses) is equivalent
to a one-heap game of Nim. The winning strategy in Nim is easy, so the
strategy for Officers becomes to convert the position to Nim,
determine the winning move, and convert back.</p>
<p>Nim is also played with heaps of coins, but the rules are simpler. In
Nim, a turn consists of choosing a pile and removing any number of
coins, possibly all of them. For a single pile, the strategy for the
first player is obvious: take the entire pile and you win. For two
equal piles, the second player can win: replicate whatever move is
made on one pile to the other, and eventually the first player will
run out of options.</p>
<p>To get at the general strategy, suppose we have a “false” Nim heap
where all the options are ordinary Nim heaps, say, a “heap” where we
can move to one of 0, 1, 4 or 5. This behaves like a heap of size 2,
but where we also have the option to increase the heap to 4 or 5. But!
These latter two moves cannot be part of a winning strategy, because
the opponent can always make a reversing move back to the (true) Nim
heap of size 2, and thereby force you to make a move to 0 or 1. And so
our false Nim heap is equivalent to the heap of size 2, the <em>minimal
excluded value</em> of all of its options. (Sanity check: for a true Nim
heap of size <span class="math inline">n</span>, indeed <span class="math inline">n</span> is the first excluded option.)</p>
<p>To determine the value <span class="math inline">x ⊕ y</span> of Nim games with two piles of size <span class="math inline">x</span>
and <span class="math inline">y</span>, we apply this rule inductively. From <span class="math inline">1 ⊕ 2</span> we can move to
any of <span class="math inline">\{0 ⊕ 2, 1 ⊕ 1, 1 ⊕ 0\}</span>, which have known values <span class="math inline">\{2, 0,
1\}</span>. The minimum excluded value is 3, so <span class="math inline">2 ⊕ 1 = 3</span>. Continuing a
little further,<span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">Computing these MEXes also reveals the winning
strategy for each sum: move to a position with value 0. So for these
sums, <span class="math inline">1 ⊕ 3 \rightsquigarrow 1 ⊕ 1</span> and <span class="math inline">2 ⊕ 3 \rightsquigarrow 2 ⊕
2</span>.<br />
<br />
</span></span></p>
<p><span class="math display">\begin{align*}
1 ⊕ 3 &amp;= \mathrm{mex}(0⊕3, 1⊕2, 1⊕1, 1⊕0) &amp;&amp;= \mathrm{mex}(3, 3, 0, 1) &amp;&amp;= 2 \\
2 ⊕ 3 &amp;= \mathrm{mex}(1⊕3, 0⊕3, 2⊕2, 2⊕1, 2⊕0) &amp;&amp;= \mathrm{mex}(2, 3, 0, 3, 2) &amp;&amp;= 1
\end{align*}</span></p>
<p>In general, one can show that the Nim sum <span class="math inline">x ⊕ y</span> is binary XOR, or if
you like, vector addition over <span class="math inline">\mathbb{F}_2</span>.</p>
<p>Now how do we apply this to Officers? We consider each Officer heap as
a false Nim heap and identify the minimal excluded value.</p>
<p>From Officers heaps of size 0 and 1 there are no moves, so <span class="math inline">G(0) =
G(1) = 0</span>. From position 2, there is a unique move to 1, so <span class="math inline">G(2) =
\mathrm{mex}(G(1)) = \mathrm{mex}(0) = 1</span>. From position 3, we now
have a choice after removing a coin: whether or not to split the
result. The two options are therefore <span class="math inline">G(2)</span> or <span class="math inline">G(1) ⊕ G(1)</span>, which
evaluate to <span class="math inline">1</span> or <span class="math inline">0</span>, so <span class="math inline">G(3) = 2</span>. Generally,</p>
<p><span class="math display"> G(x) = \mathrm{mex}(G(i) ⊕ G(x - i - 1) \mid 0 \leq i \leq x-1) </span></p>
<p>with <span class="math inline">G(0)=0</span> as a base case. The first few values are:</p>
<p><span class="math display"> 0, 0, 1, 2, 0, 1, 2, 3, 1, 2, 3, 4, 0, 3, 4, 2, 1, 3, 2, 1, \dots</span></p>
<p>This sequence appears on the OEIS as
<a href="https://oeis.org/A046695">A046695</a>. It quickly climbs out of the
single digits and then bounces around, mostly in the range <span class="math inline">[0, 256]</span>.</p>
<h2 id="calculating-naively">Calculating Naively</h2>
<p>The above formula is easily turned into a naive, <span class="math inline">O(n^2)</span> algorithm
for computing values one by one:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> values<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span>push_back<span class="op">(</span><span class="dv">0</span><span class="op">);</span> <span class="co">// G(0) = 0 base case</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span>push_back<span class="op">(</span><span class="dv">0</span><span class="op">);</span> <span class="co">// G(1) = 0 base case</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> pos <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> seen<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> pos<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      seen<span class="op">.</span>insert<span class="op">(</span>values<span class="op">[</span>i<span class="op">]</span> <span class="op">^</span> values<span class="op">[</span>pos <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span><span class="op">]);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> mex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>seen<span class="op">.</span>count<span class="op">(</span>mex<span class="op">))</span> mex<span class="op">++;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    values<span class="op">.</span>push_back<span class="op">(</span>mex<span class="op">);</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;G(&quot;</span> <span class="op">&lt;&lt;</span> pos <span class="op">&lt;&lt;</span> <span class="st">&quot;) = &quot;</span> <span class="op">&lt;&lt;</span> mex <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    pos<span class="op">++;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>There are a couple of basic improvements we can make. Firstly, we only
need to run through around half the loop, because past the midpoint we
are computing the XOR of the same values but swapped.</p>
<p>Secondly, all known values (into the trillions) are less than 512, so
we are better off using a <code>std::array&lt;bool, 512&gt;</code> or similar to record
the values that we are applying MEX to. We are willing to take the
gamble that we will never calculate values for long enough to see them
reach 512.</p>
<p>The result is an algorithm that calculates values at around 11K values
per second. (And which slows down as time passes.)</p>
<h2 id="the-rare-value-algorithm">The Rare-Value Algorithm</h2>
<p>Empirically, some values appear far more often than others. This is
underselling it: there are a handful of values that occur a finite
number of times and then never seem to appear again.<span class="sidenote-wrapper"><label for="sn-5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-5" class="margin-toggle" /><span class="sidenote">Notably the
value 0 is one of these, so there are only finitely many (known)
positions that are losing for the first player. These are positions 0,
1, 4, 12, 20, 30, 46, 72, 98, 124, 150, 176, 314 and 408.<br />
<br />
</span></span> There are
exactly <span class="math inline">1584</span> (known) positions that have “rare” values, the final
one occurring at <span class="math inline">G(20627)=277</span>.</p>
<p>The sequence of rare values (not positions) begins</p>
<p><span class="math display"> 0, 1, 6, 7, 10, 11, 12, 13, 16, 17, 22, 23, 26, 27, 28, 29, \dots </span></p>
<p>The pattern here is not so obvious. It turns out that a rare value is
one that has an even number of set bits after throwing out the 0th and
4th bits.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> is_rare<span class="op">(</span><span class="dt">uint16_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> mask <span class="op">=</span> <span class="bn">0b10001</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span><span class="fu">__builtin_popcount</span><span class="op">(</span>x <span class="op">&amp;</span> <span class="op">~</span>mask<span class="op">)</span> <span class="op">%</span> <span class="dv">2</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Many octal games have an analogous property that divides rare values
from common ones. There is no rhyme or reason to which bits end up the
relevant ones for this property, they seem to emerge from the chaos of
the initial handful of values. But once a pattern like this is
established it is almost impossible to dislodge, for the following
reason. Because the condition is based on parity, it is not hard to
check the rules:</p>
<p><span class="math display">\begin{align*}
&amp;\text{common} &amp;&amp;\oplus \,\text{common} &amp;&amp;= \text{rare} \\
&amp;\text{rare} &amp;&amp;\oplus \,\text{rare} &amp;&amp;= \text{rare} \\
&amp;\text{rare} &amp;&amp;\oplus \,\text{common} &amp;&amp;= \text{common}
\end{align*}</span></p>
<p>Now consider the collection <span class="math inline">\{G(i) ⊕ G(x - i - 1) \mid 0 \leq i \leq
x-1\}</span> that we are taking the MEX of to determine <span class="math inline">G(x)</span>.
As <span class="math inline">x</span> becomes large, the values <span class="math inline">G(i) ⊕ G(x - i - 1)</span> will be
dominated by those of the form <span class="math inline">(\text{common} \oplus \text{common})</span>,
i.e. rare values, because there are vastly more common values than
rare ones. The first missing value is therefore likely to be common,
because only members of the smaller collection of sums <span class="math inline">(\text{rare}
\oplus \text{common})</span> are capable of landing on common values.</p>
<p>Knowing that values are likely to be common suggests the following
approach. First, calculate all <span class="math inline">(\text{rare} \oplus \text{common})</span>
sums, and thereby determine the first missing <em>common</em> value. This is
overwhelmingly likely to be the correct value in the end, but to
verify this we’ll have to check sums not of this form. Here’s the key:
we only have to rule out the rare values <em>below</em> this missing common
value, and as soon as we’ve done this we can stop. Usually, the rare
possibilities can be eliminated after checking a small number of
additional sums. No further sums can possibly eliminate that first
missing common value.</p>
<p>Here’s how this might look.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">uint16_t</span><span class="op">&gt;</span> values<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span>push_back<span class="op">(</span><span class="dv">0</span><span class="op">);</span> <span class="co">// G(0) = 0 base case</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span>push_back<span class="op">(</span><span class="dv">0</span><span class="op">);</span> <span class="co">// G(1) = 0 base case</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>pair<span class="op">&lt;</span><span class="dt">uint64_t</span><span class="op">,</span> <span class="dt">uint16_t</span><span class="op">&gt;&gt;</span> rares<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  rares<span class="op">.</span>push_back<span class="op">({</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">});</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  rares<span class="op">.</span>push_back<span class="op">({</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">});</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> pos <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>array<span class="op">&lt;</span><span class="dt">bool</span><span class="op">,</span> <span class="dv">512</span><span class="op">&gt;</span> seen<span class="op">{};</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First calculate the sums that result in common values:</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">[</span>rare_pos<span class="op">,</span> rare_value<span class="op">]</span> <span class="op">:</span> rares<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">uint16_t</span> option <span class="op">=</span> rare_value <span class="op">^</span> values<span class="op">[</span>pos <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_pos<span class="op">];</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      seen<span class="op">[</span>option<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine the first missing common value:</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> mex_common <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>is_rare<span class="op">(</span>mex_common<span class="op">)</span> <span class="op">||</span> seen<span class="op">[</span>mex_common<span class="op">])</span> <span class="op">{</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      mex_common<span class="op">++;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Count how many rare values below that have to be excluded:</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> missing_rare <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> mex_common<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>is_rare<span class="op">(</span>i<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>seen<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        missing_rare<span class="op">++;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate all sums until those rare values are covered:</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> pos<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">uint16_t</span> option <span class="op">=</span> values<span class="op">[</span>i<span class="op">]</span> <span class="op">^</span> values<span class="op">[</span>pos <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> i<span class="op">];</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>option <span class="op">&lt;</span> mex_common <span class="op">&amp;&amp;</span> <span class="op">!</span>seen<span class="op">[</span>option<span class="op">])</span> <span class="op">{</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        seen<span class="op">[</span>option<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        missing_rare<span class="op">--;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>missing_rare <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>missing_rare <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If we got them all, the result is indeed common:</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>      values<span class="op">.</span>push_back<span class="op">(</span>mex_common<span class="op">);</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;G(&quot;</span> <span class="op">&lt;&lt;</span> pos <span class="op">&lt;&lt;</span> <span class="st">&quot;) = &quot;</span> <span class="op">&lt;&lt;</span> mex_common <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Otherwise, we have found a new rare value:</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Calculate the true mex:</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">uint16_t</span> mex_rare <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="op">(</span>seen<span class="op">[</span>mex_rare<span class="op">])</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        mex_rare<span class="op">++;</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>      values<span class="op">.</span>push_back<span class="op">(</span>mex_rare<span class="op">);</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>      rares<span class="op">.</span>push_back<span class="op">({</span>pos<span class="op">,</span> mex_rare<span class="op">});</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;G(&quot;</span> <span class="op">&lt;&lt;</span> pos <span class="op">&lt;&lt;</span> <span class="st">&quot;) = &quot;</span> <span class="op">&lt;&lt;</span> mex_rare </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;&lt;</span> <span class="st">&quot; New rare!&quot;</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    pos<span class="op">++;</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is a big improvement: we are now generating values at a rate of
50K/s. For now, we’re going to put aside the verification step and
focus on calculating the speculative common values as fast as
possible. There is a good parallelisable algorithm for verifying these
common values<span class="sidenote-wrapper"><label for="sn-6" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-6" class="margin-toggle" /><span class="sidenote">You can do the verification for each value completely
independently, under the assumption that the values that came before
it were correct. Only rarely (i.e. apparently never) is this
assumption violated, at which point you can redo the later ones that
relied on that incorrect value. And we had better hope it never
actually happens, because a new rare value out past 140 trillion will
make solving the game basically impossible.<br />
<br />
</span></span>, so if our goal is push
the calculation further than Grossman then getting these candidate
values as fast as possible is the whole ballgame.</p>
<h2 id="values-as-bytes">Values as Bytes</h2>
<p>Grossman observes that, because a) all known values are less than 512
and b) common values obey a parity constraint, we can compress common
values into 8 bits instead of 9. This is a big win: we can store each
value in one byte rather than two. He does this by chopping off the
highest bit and reconstructing it when necessary. Importantly, this
doesn’t affect the calculation of the Nim sum:</p>
<p><span class="math display">\mathrm{compress}(x \oplus y) = \mathrm{compress}(x) \oplus \mathrm{compress}(y) </span></p>
<p>Here we can make a minor improvement. The downside of removing the
highest bit is that this doesn’t preserve order. The difference has to
be accounted for when calculating the MEX, to avoid picking an
incorrect “smallest value”.</p>
<p>Instead, we can cut out the 1st bit and shift all higher bits down by
one. This does preserve order, and so we only ever have to think about
compression when we want to present the output.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> compress<span class="op">(</span><span class="dt">uint16_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">((</span>x <span class="op">&gt;&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">~</span><span class="bn">0b1</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span>x <span class="op">&amp;</span> <span class="bn">0b1</span><span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="dt">uint16_t</span> uncompress<span class="op">(</span><span class="dt">uint8_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> pop <span class="op">=</span> __popc<span class="op">(</span>x <span class="op">&amp;</span> <span class="bn">0b11110110</span><span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> bit1 <span class="op">=</span> <span class="op">(</span>pop <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> <span class="bn">0b10</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">((</span>x <span class="op">&amp;</span> <span class="bn">0b11111110</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">|</span> bit1 <span class="op">|</span> <span class="op">(</span>x <span class="op">&amp;</span> <span class="bn">0b1</span><span class="op">);</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>(Or if you like, that line could be <code>bit1 = (~pop &amp; 1) &lt;&lt; 1</code>.)</p>
<h2 id="calculating-a-block-of-values">Calculating a Block of Values</h2>
<p>The above few sections have just been recapitulating previous work,
now it’s time to do something GPU specific.</p>
<p>In CUDA, operations are performed in “blocks” of “threads”, with a
block executed collectively on a “streaming multiprocessor”.<span class="sidenote-wrapper"><label for="sn-7" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-7" class="margin-toggle" /><span class="sidenote">I am
going to stop with the scare quotes now.<br />
<br />
</span></span> For hardware reasons, it is
best for a block to have some multiple of 32 threads; a typical number
might be 256. Our plan is to have each thread compute one additional
Officers value. Let’s focus on a single block to keep things simple
for now.</p>
<p>Suppose we already know all values at positions smaller than <span class="math inline">n</span> and
we are now trying to simultaneously compute the values for the range
<span class="math inline">[n, n+B)</span>, where <span class="math inline">B</span> is the number of threads in our block. Our goal
is to run the first loop of the above algorithm simultaneously over
the block. So that all threads can make progress at the same time, we
want the computation to be as uniform as possible across those
threads. For each rare position <span class="math inline">p</span>, all threads will calculate <span class="math inline">G(p)
\oplus G(x - 1 - p)</span> for that rare value<span class="sidenote-wrapper"><label for="sn-8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-8" class="margin-toggle" /><span class="sidenote">These rare values and their
locations can be stored in <code>__constant__</code> memory, luckily it is fast
to broadcast a single value from constant memory to all threads in a
block.<br />
<br />
</span></span>, and record the result as ruled out for the MEX. In other
words, at each step we are using a <span class="math inline">B</span> sized window over the previous
values, whose location is determined by the position of each rare
value. We’ll run through the rare positions largest to smallest, so
that the range of previous values we’re inspecting moves from to
oldest to newest, with the window starting on the range <span class="math inline">[n-M, n-M+B)</span>
and ending on the range <span class="math inline">[n, n+B)</span>, where <span class="math inline">M=20627</span> is the position of
the last known rare value.</p>
<p>Of course, we have to be careful: the values in the range <span class="math inline">[n, n+B)</span>
aren’t actually known yet, they’re what we’re calculating right now.
The computation naturally splits into two phases:<span class="sidenote-wrapper"><label for="sn-9" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-9" class="margin-toggle" /><span class="sidenote">These diagrams may
not be very helpful, but it was satisfying to get TiKZ working on this
page.<br />
<br />
</span></span></p>
<ol type="1">
<li><p><strong>Backwards:</strong> For all threads simultaneously, compute the sums
involving a rare value and an already-known common value. So for
the rare value at position <span class="math inline">p</span>, we are reading the window:</p>
<div class="figure">
<!--\tikzstyle{Interval} = [
  draw, anchor=west,
  inner sep=0,
  outer sep=0,
  minimum height=1cm,
  text=black,
  very thick
]
\node[Interval, minimum width=10cm] (first) {};
\node[Interval, minimum width=4cm, right=0cm of first, dashed] (second) {};
\node[Interval, minimum width=4cm, anchor=center, fill=lightgray] (prev) at (first.center) {};
\draw[-stealth, thick] (second.center) to (prev.center);
\node[below=0.8cm of first.south east, anchor=base] {$n$};
\node[below=0.8cm of first.south west, anchor=base] {$n - M$};
\node[below=0.8cm of second.south east, anchor=base] {$n + B$};
\node[below=0.8cm of prev.south west, anchor=base] {$n - p$};
\node[below=0.8cm of prev.south east, anchor=base] {$n - p + B$};-->
<img src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20width%3D%22443.698pt%22%20height%3D%2258.313pt%22%20viewBox%3D%220%200%20443.698%2058.313%22%3E%3Cdefs%3E%3Cg%3E%3Cg%20id%3D%22glyph-0-0%22%3E%3Cpath%20d%3D%22M%207.71875%20-2.28125%20C%207.46875%20-2.28125%207.4375%20-2.09375%207.390625%20-1.90625%20C%207.265625%20-1.484375%207.125%20-1.140625%206.953125%20-0.890625%20C%206.78125%20-0.578125%206.5%20-0.265625%206.09375%20-0.265625%20C%205.875%20-0.265625%205.859375%20-0.375%205.859375%20-0.609375%20C%205.859375%20-0.921875%206.015625%20-1.328125%206.078125%20-1.546875%20C%206.28125%20-2.0625%206.515625%20-2.71875%206.71875%20-3.421875%20C%206.84375%20-3.84375%206.96875%20-4.28125%206.96875%20-4.765625%20C%206.96875%20-5.78125%206.328125%20-6.375%205.265625%20-6.375%20C%204.28125%20-6.375%203.609375%20-5.859375%203.171875%20-5.328125%20C%203.03125%20-5.921875%202.53125%20-6.375%201.84375%20-6.375%20C%200.875%20-6.375%200.578125%20-5.34375%200.375%20-4.5625%20C%200.3125%20-4.359375%200.25%20-4.25%200.25%20-4.078125%20C%200.25%20-3.921875%200.375%20-3.828125%200.53125%20-3.828125%20C%200.8125%20-3.828125%200.828125%20-4.03125%200.875%20-4.265625%20C%200.984375%20-4.703125%201.109375%20-5.15625%201.3125%20-5.484375%20C%201.421875%20-5.671875%201.546875%20-5.84375%201.796875%20-5.84375%20C%202.078125%20-5.84375%202.109375%20-5.59375%202.109375%20-5.3125%20C%202.109375%20-4.859375%201.96875%20-4.453125%201.875%20-4.03125%20C%201.640625%20-3.140625%201.421875%20-2.25%201.1875%20-1.34375%20C%201.140625%20-1.140625%201.0625%20-0.84375%201%20-0.609375%20C%200.984375%20-0.453125%200.9375%20-0.359375%200.9375%20-0.21875%20C%200.9375%200.0625%201.140625%200.265625%201.4375%200.265625%20C%201.75%200.265625%201.984375%200.0625%202.0625%20-0.21875%20C%202.4375%20-1.484375%202.71875%20-2.8125%203.046875%20-4.109375%20C%203.359375%20-4.90625%204.171875%20-5.84375%205.234375%20-5.84375%20C%205.71875%20-5.84375%205.859375%20-5.46875%205.859375%20-4.96875%20C%205.859375%20-4.828125%205.84375%20-4.640625%205.8125%20-4.4375%20C%205.65625%20-3.578125%205.25%20-2.4375%205.015625%20-1.828125%20C%204.890625%20-1.5%204.796875%20-1.296875%204.796875%20-1%20C%204.796875%20-0.28125%205.296875%200.265625%206.046875%200.265625%20C%206.328125%200.265625%206.5625%200.1875%206.78125%200.0625%20C%207.28125%20-0.25%207.640625%20-0.890625%207.84375%20-1.484375%20C%207.921875%20-1.703125%208%20-1.828125%208%20-2.03125%20C%208%20-2.1875%207.859375%20-2.28125%207.71875%20-2.28125%20Z%20M%207.71875%20-2.28125%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-1%22%3E%3Cpath%20d%3D%22M%2012.234375%20-0.265625%20C%2012.234375%20-0.515625%2012.015625%20-0.53125%2011.78125%20-0.53125%20C%2011.765625%20-0.53125%2011.765625%20-0.53125%2011.765625%20-0.53125%20C%2011.515625%20-0.53125%2011.03125%20-0.515625%2011.03125%20-0.671875%20C%2011.03125%20-0.71875%2011.046875%20-0.8125%2011.046875%20-0.859375%20L%2013%20-8.609375%20C%2013.015625%20-8.703125%2013.03125%20-8.765625%2013.046875%20-8.828125%20C%2013.1875%20-9.1875%2013.546875%20-9.140625%2014.03125%20-9.140625%20C%2014.03125%20-9.140625%2014.046875%20-9.140625%2014.046875%20-9.140625%20C%2014.375%20-9.140625%2014.546875%20-9.21875%2014.546875%20-9.53125%20C%2014.546875%20-9.796875%2014.34375%20-9.8125%2014.09375%20-9.8125%20L%2012.359375%20-9.8125%20C%2011.984375%20-9.8125%2011.859375%20-9.734375%2011.71875%20-9.515625%20L%206.75%20-1.625%20L%205.71875%20-9.375%20C%205.6875%20-9.734375%205.5625%20-9.8125%205.1875%20-9.8125%20L%203.40625%20-9.8125%20C%203.078125%20-9.8125%202.890625%20-9.734375%202.890625%20-9.40625%20C%202.890625%20-9.171875%203.109375%20-9.140625%203.34375%20-9.140625%20C%203.359375%20-9.140625%203.359375%20-9.140625%203.359375%20-9.140625%20C%203.609375%20-9.140625%204.09375%20-9.171875%204.09375%20-9%20C%204.09375%20-8.90625%204.078125%20-8.828125%204.03125%20-8.703125%20L%202.21875%20-1.46875%20C%202.0625%20-0.8125%201.703125%20-0.578125%200.90625%20-0.53125%20C%200.6875%20-0.53125%200.5625%20-0.375%200.5625%20-0.15625%20C%200.5625%200.03125%200.6875%200.125%200.875%200.125%20L%202.171875%200.09375%20L%202.84375%200.09375%20C%203.046875%200.09375%203.28125%200.125%203.484375%200.125%20C%203.734375%200.125%203.875%20-0.015625%203.875%20-0.265625%20C%203.875%20-0.453125%203.71875%20-0.53125%203.546875%20-0.53125%20C%203.125%20-0.546875%202.75%20-0.59375%202.75%20-1.015625%20C%202.75%20-1.1875%202.75%20-1.15625%202.8125%20-1.34375%20L%204.609375%20-8.546875%20L%205.703125%20-0.375%20C%205.71875%20-0.109375%205.734375%200.125%206.015625%200.125%20C%206.234375%200.125%206.328125%20-0.03125%206.421875%20-0.171875%20L%2011.703125%20-8.546875%20L%209.828125%20-1.078125%20C%209.828125%20-0.984375%209.796875%20-0.921875%209.78125%20-0.84375%20C%209.671875%20-0.515625%209.296875%20-0.53125%208.8125%20-0.53125%20C%208.8125%20-0.53125%208.796875%20-0.53125%208.796875%20-0.53125%20C%208.46875%20-0.53125%208.28125%20-0.484375%208.28125%20-0.15625%20C%208.28125%200.046875%208.40625%200.125%208.609375%200.125%20C%208.859375%200.125%209.140625%200.09375%209.375%200.09375%20L%2011.046875%200.09375%20C%2011.296875%200.09375%2011.59375%200.125%2011.828125%200.125%20C%2011.828125%200.125%2011.828125%200.125%2011.84375%200.125%20C%2012.109375%200.125%2012.234375%20-0.015625%2012.234375%20-0.265625%20Z%20M%2012.234375%20-0.265625%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-2%22%3E%3Cpath%20d%3D%22M%208.4375%20-3.21875%20C%208.4375%20-2.96875%208.390625%20-2.703125%208.3125%20-2.453125%20C%207.9375%20-1.390625%206.90625%20-0.53125%205.5625%20-0.53125%20L%203.65625%20-0.53125%20C%203.546875%20-0.53125%203.296875%20-0.53125%203.296875%20-0.578125%20C%203.296875%20-0.65625%203.328125%20-0.78125%203.359375%20-0.859375%20L%204.328125%20-4.765625%20L%206.890625%20-4.765625%20C%207.875%20-4.765625%208.4375%20-4.15625%208.4375%20-3.21875%20Z%20M%202.875%20-9.40625%20C%202.875%20-9.171875%203.09375%20-9.140625%203.328125%20-9.140625%20C%203.34375%20-9.140625%203.34375%20-9.140625%203.34375%20-9.140625%20C%203.59375%20-9.140625%204.078125%20-9.171875%204.078125%20-9%20C%204.078125%20-8.90625%204.0625%20-8.828125%204.03125%20-8.703125%20L%202.109375%20-1.0625%20C%202.09375%20-0.984375%202.0625%20-0.921875%202.0625%20-0.84375%20C%201.9375%20-0.515625%201.578125%20-0.53125%201.09375%20-0.53125%20C%201.09375%20-0.53125%201.078125%20-0.53125%201.078125%20-0.53125%20C%200.75%20-0.53125%200.546875%20-0.484375%200.546875%20-0.15625%20C%200.546875%200.109375%200.75%200.125%201.015625%200.125%20L%205.90625%200.125%20C%207.421875%200.125%208.671875%20-0.65625%209.34375%20-1.578125%20C%209.640625%20-1.96875%209.875%20-2.453125%209.875%20-3.078125%20C%209.875%20-4.203125%209.0625%20-4.8125%208.171875%20-5.078125%20C%208.5625%20-5.203125%208.921875%20-5.359375%209.234375%20-5.5625%20C%209.921875%20-6%2010.65625%20-6.71875%2010.65625%20-7.71875%20C%2010.65625%20-7.921875%2010.625%20-8.109375%2010.578125%20-8.296875%20C%2010.265625%20-9.265625%209.25%20-9.8125%207.953125%20-9.8125%20L%203.390625%20-9.8125%20C%203.0625%20-9.8125%202.875%20-9.734375%202.875%20-9.40625%20Z%20M%209.234375%20-7.78125%20C%209.234375%20-7.171875%208.953125%20-6.6875%208.625%20-6.3125%20C%208.15625%20-5.75%207.375%20-5.296875%206.34375%20-5.296875%20L%204.484375%20-5.296875%20L%205.3125%20-8.6875%20C%205.34375%20-8.8125%205.375%20-8.921875%205.40625%20-8.96875%20C%205.46875%20-9.171875%205.640625%20-9.140625%205.921875%20-9.140625%20L%207.765625%20-9.140625%20C%208.6875%20-9.140625%209.234375%20-8.640625%209.234375%20-7.78125%20Z%20M%209.234375%20-7.78125%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-3%22%3E%3Cpath%20d%3D%22M%205.71875%20-4.609375%20C%205.71875%20-4.484375%205.71875%20-4.328125%205.6875%20-4.125%20C%205.5625%20-3.28125%205.296875%20-2.3125%204.984375%20-1.640625%20C%204.796875%20-1.234375%204.515625%20-0.84375%204.203125%20-0.59375%20C%204%20-0.421875%203.765625%20-0.265625%203.4375%20-0.265625%20C%202.8125%20-0.265625%202.515625%20-0.859375%202.453125%20-1.421875%20C%202.453125%20-1.46875%202.484375%20-1.5625%202.5%20-1.609375%20L%203.1875%20-4.390625%20C%203.28125%20-4.765625%203.640625%20-5.125%203.875%20-5.328125%20C%204.0625%20-5.515625%204.5%20-5.84375%204.953125%20-5.84375%20C%205.546875%20-5.84375%205.71875%20-5.21875%205.71875%20-4.609375%20Z%20M%201.90625%20-6.375%20C%200.9375%20-6.375%200.65625%20-5.359375%200.4375%20-4.5625%20C%200.375%20-4.375%200.328125%20-4.25%200.328125%20-4.078125%20C%200.328125%20-3.921875%200.453125%20-3.828125%200.609375%20-3.828125%20C%200.875%20-3.828125%200.890625%20-4.03125%200.953125%20-4.265625%20C%201.0625%20-4.6875%201.171875%20-5.140625%201.375%20-5.484375%20C%201.484375%20-5.65625%201.609375%20-5.84375%201.875%20-5.84375%20C%202.15625%20-5.84375%202.1875%20-5.59375%202.1875%20-5.3125%20C%202.1875%20-5.015625%202.140625%20-4.84375%202.078125%20-4.609375%20L%200.484375%201.765625%20C%200.453125%201.875%200.4375%201.953125%200.40625%202.015625%20C%200.34375%202.203125%200.171875%202.203125%20-0.125%202.203125%20C%20-0.125%202.203125%20-0.140625%202.203125%20-0.140625%202.203125%20C%20-0.421875%202.203125%20-0.5625%202.328125%20-0.5625%202.609375%20C%20-0.5625%202.75%20-0.4375%202.875%20-0.265625%202.875%20C%20-0.078125%202.875%200.109375%202.84375%200.296875%202.84375%20L%200.90625%202.84375%20L%202.21875%202.875%20C%202.484375%202.875%202.609375%202.75%202.609375%202.5%20C%202.609375%202.234375%202.421875%202.203125%202.171875%202.203125%20C%202.15625%202.203125%202.15625%202.203125%202.140625%202.203125%20C%201.9375%202.203125%201.578125%202.203125%201.578125%202.125%20C%201.578125%202.125%201.578125%202.125%201.578125%202.109375%20C%201.6875%201.375%202.046875%200.21875%202.203125%20-0.453125%20C%202.4375%20-0.078125%202.8125%200.265625%203.4375%200.265625%20C%203.78125%200.265625%204.125%200.1875%204.453125%200.03125%20C%204.859375%20-0.15625%205.25%20-0.453125%205.578125%20-0.828125%20C%206.28125%20-1.5625%206.90625%20-2.671875%206.90625%20-4.03125%20C%206.90625%20-4.484375%206.8125%20-4.890625%206.65625%20-5.234375%20C%206.375%20-5.859375%205.859375%20-6.375%204.96875%20-6.375%20C%204.78125%20-6.375%204.59375%20-6.328125%204.421875%20-6.28125%20C%203.921875%20-6.109375%203.515625%20-5.765625%203.21875%20-5.4375%20C%203.03125%20-5.96875%202.5625%20-6.375%201.90625%20-6.375%20Z%20M%201.90625%20-6.375%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-1-0%22%3E%3Cpath%20d%3D%22M%209.375%20-3.953125%20L%201.625%20-3.953125%20C%201.296875%20-3.953125%201.046875%20-3.890625%201.046875%20-3.546875%20C%201.046875%20-3.203125%201.296875%20-3.125%201.625%20-3.125%20L%209.375%20-3.125%20C%209.703125%20-3.125%209.96875%20-3.203125%209.96875%20-3.546875%20C%209.96875%20-3.890625%209.703125%20-3.953125%209.375%20-3.953125%20Z%20M%209.375%20-3.953125%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-2-0%22%3E%3Cpath%20d%3D%22M%209.578125%20-3.921875%20L%205.78125%20-3.921875%20L%205.78125%20-7.71875%20C%205.78125%20-8.015625%205.71875%20-8.296875%205.40625%20-8.296875%20C%205.078125%20-8.296875%205%20-8.03125%205%20-7.71875%20L%205%20-3.921875%20L%201.21875%20-3.921875%20C%200.90625%20-3.921875%200.640625%20-3.875%200.640625%20-3.546875%20C%200.640625%20-3.21875%200.890625%20-3.140625%201.203125%20-3.140625%20L%205%20-3.140625%20L%205%200.65625%20C%205%200.953125%205.0625%201.21875%205.390625%201.21875%20C%205.71875%201.21875%205.78125%200.96875%205.78125%200.65625%20L%205.78125%20-3.140625%20L%209.578125%20-3.140625%20C%209.875%20-3.140625%2010.140625%20-3.203125%2010.140625%20-3.53125%20C%2010.140625%20-3.859375%209.890625%20-3.921875%209.578125%20-3.921875%20Z%20M%209.578125%20-3.921875%20%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fdefs%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20-0.000123514%20-14.171477%20L%20283.468574%20-14.171477%20L%20283.468574%2014.174207%20L%20-0.000123514%2014.174207%20Z%20M%20-0.000123514%20-14.171477%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-dasharray%3D%222.98883%202.98883%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20283.468574%20-14.171477%20L%20396.855263%20-14.171477%20L%20396.855263%2014.174207%20L%20283.468574%2014.174207%20Z%20M%20283.468574%20-14.171477%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill-rule%3D%22nonzero%22%20fill%3D%22rgb%2875%25%2C%2075%25%2C%2075%25%29%22%20fill-opacity%3D%221%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%2085.040881%20-14.171477%20L%20198.427569%20-14.171477%20L%20198.427569%2014.174207%20L%2085.040881%2014.174207%20Z%20M%2085.040881%20-14.171477%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%220.79701%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20340.159942%200.00136512%20L%20144.324939%200.00136512%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill-rule%3D%22nonzero%22%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%20d%3D%22M%20166.636719%2014.597656%20L%20170.734375%2016.648438%20L%20169.199219%2014.597656%20L%20170.734375%2012.550781%20%22%2F%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22302.574947%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%226.290548%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-1-0%22%20x%3D%2217.726034%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-1%22%20x%3D%2231.90235%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22400.458754%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-2-0%22%20x%3D%22411.89424%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-2%22%20x%3D%22425.840854%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%2294.311551%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-1-0%22%20x%3D%22105.747036%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-3%22%20x%3D%22119.923353%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22192.195357%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-1-0%22%20x%3D%22203.630843%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-3%22%20x%3D%22217.807159%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-2-0%22%20x%3D%22227.936745%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-2%22%20x%3D%22241.883359%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E" class="tikzpicture" />
</div>
<p>If for a thread the relevant previous value is still unknown, do
nothing. This happens when the rare value has position <span class="math inline">p \in [0,
B]</span> and the current thread <span class="math inline">x</span> has <span class="math inline">x &gt; p</span>, because then <span class="math inline">n + x -
p - 1 \geq n</span> is an unknown position. And so the window is shorter:</p>
<div class="figure">
<!--\tikzstyle{Interval} = [
  draw, anchor=west,
  inner sep=0,
  outer sep=0,
  minimum height=1cm,
  text=black,
  very thick
]
\node[Interval, minimum width=10cm] (first) {};
\node[Interval, minimum width=4cm, right=0cm of first, dashed] (second) {};
\node[Interval, minimum width=2cm, anchor=east, fill=lightgray] (prev) at (first.east) {};
\draw[-stealth, thick] (second.center) to (prev.center);
\node[below=0.8cm of first.south east, anchor=base] {$n$};
\node[below=0.8cm of first.south west, anchor=base] {$n - M$};
\node[below=0.8cm of second.south east, anchor=base] {$n + B$};
\node[below=0.8cm of prev.south west, anchor=base] {$n - p$};-->
<img src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20width%3D%22443.698pt%22%20height%3D%2258.313pt%22%20viewBox%3D%220%200%20443.698%2058.313%22%3E%3Cdefs%3E%3Cg%3E%3Cg%20id%3D%22glyph-0-0%22%3E%3Cpath%20d%3D%22M%207.71875%20-2.28125%20C%207.46875%20-2.28125%207.4375%20-2.09375%207.390625%20-1.90625%20C%207.265625%20-1.484375%207.125%20-1.140625%206.953125%20-0.890625%20C%206.78125%20-0.578125%206.5%20-0.265625%206.09375%20-0.265625%20C%205.875%20-0.265625%205.859375%20-0.375%205.859375%20-0.609375%20C%205.859375%20-0.921875%206.015625%20-1.328125%206.078125%20-1.546875%20C%206.28125%20-2.0625%206.515625%20-2.71875%206.71875%20-3.421875%20C%206.84375%20-3.84375%206.96875%20-4.28125%206.96875%20-4.765625%20C%206.96875%20-5.78125%206.328125%20-6.375%205.265625%20-6.375%20C%204.28125%20-6.375%203.609375%20-5.859375%203.171875%20-5.328125%20C%203.03125%20-5.921875%202.53125%20-6.375%201.84375%20-6.375%20C%200.875%20-6.375%200.578125%20-5.34375%200.375%20-4.5625%20C%200.3125%20-4.359375%200.25%20-4.25%200.25%20-4.078125%20C%200.25%20-3.921875%200.375%20-3.828125%200.53125%20-3.828125%20C%200.8125%20-3.828125%200.828125%20-4.03125%200.875%20-4.265625%20C%200.984375%20-4.703125%201.109375%20-5.15625%201.3125%20-5.484375%20C%201.421875%20-5.671875%201.546875%20-5.84375%201.796875%20-5.84375%20C%202.078125%20-5.84375%202.109375%20-5.59375%202.109375%20-5.3125%20C%202.109375%20-4.859375%201.96875%20-4.453125%201.875%20-4.03125%20C%201.640625%20-3.140625%201.421875%20-2.25%201.1875%20-1.34375%20C%201.140625%20-1.140625%201.0625%20-0.84375%201%20-0.609375%20C%200.984375%20-0.453125%200.9375%20-0.359375%200.9375%20-0.21875%20C%200.9375%200.0625%201.140625%200.265625%201.4375%200.265625%20C%201.75%200.265625%201.984375%200.0625%202.0625%20-0.21875%20C%202.4375%20-1.484375%202.71875%20-2.8125%203.046875%20-4.109375%20C%203.359375%20-4.90625%204.171875%20-5.84375%205.234375%20-5.84375%20C%205.71875%20-5.84375%205.859375%20-5.46875%205.859375%20-4.96875%20C%205.859375%20-4.828125%205.84375%20-4.640625%205.8125%20-4.4375%20C%205.65625%20-3.578125%205.25%20-2.4375%205.015625%20-1.828125%20C%204.890625%20-1.5%204.796875%20-1.296875%204.796875%20-1%20C%204.796875%20-0.28125%205.296875%200.265625%206.046875%200.265625%20C%206.328125%200.265625%206.5625%200.1875%206.78125%200.0625%20C%207.28125%20-0.25%207.640625%20-0.890625%207.84375%20-1.484375%20C%207.921875%20-1.703125%208%20-1.828125%208%20-2.03125%20C%208%20-2.1875%207.859375%20-2.28125%207.71875%20-2.28125%20Z%20M%207.71875%20-2.28125%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-1%22%3E%3Cpath%20d%3D%22M%2012.234375%20-0.265625%20C%2012.234375%20-0.515625%2012.015625%20-0.53125%2011.78125%20-0.53125%20C%2011.765625%20-0.53125%2011.765625%20-0.53125%2011.765625%20-0.53125%20C%2011.515625%20-0.53125%2011.03125%20-0.515625%2011.03125%20-0.671875%20C%2011.03125%20-0.71875%2011.046875%20-0.8125%2011.046875%20-0.859375%20L%2013%20-8.609375%20C%2013.015625%20-8.703125%2013.03125%20-8.765625%2013.046875%20-8.828125%20C%2013.1875%20-9.1875%2013.546875%20-9.140625%2014.03125%20-9.140625%20C%2014.03125%20-9.140625%2014.046875%20-9.140625%2014.046875%20-9.140625%20C%2014.375%20-9.140625%2014.546875%20-9.21875%2014.546875%20-9.53125%20C%2014.546875%20-9.796875%2014.34375%20-9.8125%2014.09375%20-9.8125%20L%2012.359375%20-9.8125%20C%2011.984375%20-9.8125%2011.859375%20-9.734375%2011.71875%20-9.515625%20L%206.75%20-1.625%20L%205.71875%20-9.375%20C%205.6875%20-9.734375%205.5625%20-9.8125%205.1875%20-9.8125%20L%203.40625%20-9.8125%20C%203.078125%20-9.8125%202.890625%20-9.734375%202.890625%20-9.40625%20C%202.890625%20-9.171875%203.109375%20-9.140625%203.34375%20-9.140625%20C%203.359375%20-9.140625%203.359375%20-9.140625%203.359375%20-9.140625%20C%203.609375%20-9.140625%204.09375%20-9.171875%204.09375%20-9%20C%204.09375%20-8.90625%204.078125%20-8.828125%204.03125%20-8.703125%20L%202.21875%20-1.46875%20C%202.0625%20-0.8125%201.703125%20-0.578125%200.90625%20-0.53125%20C%200.6875%20-0.53125%200.5625%20-0.375%200.5625%20-0.15625%20C%200.5625%200.03125%200.6875%200.125%200.875%200.125%20L%202.171875%200.09375%20L%202.84375%200.09375%20C%203.046875%200.09375%203.28125%200.125%203.484375%200.125%20C%203.734375%200.125%203.875%20-0.015625%203.875%20-0.265625%20C%203.875%20-0.453125%203.71875%20-0.53125%203.546875%20-0.53125%20C%203.125%20-0.546875%202.75%20-0.59375%202.75%20-1.015625%20C%202.75%20-1.1875%202.75%20-1.15625%202.8125%20-1.34375%20L%204.609375%20-8.546875%20L%205.703125%20-0.375%20C%205.71875%20-0.109375%205.734375%200.125%206.015625%200.125%20C%206.234375%200.125%206.328125%20-0.03125%206.421875%20-0.171875%20L%2011.703125%20-8.546875%20L%209.828125%20-1.078125%20C%209.828125%20-0.984375%209.796875%20-0.921875%209.78125%20-0.84375%20C%209.671875%20-0.515625%209.296875%20-0.53125%208.8125%20-0.53125%20C%208.8125%20-0.53125%208.796875%20-0.53125%208.796875%20-0.53125%20C%208.46875%20-0.53125%208.28125%20-0.484375%208.28125%20-0.15625%20C%208.28125%200.046875%208.40625%200.125%208.609375%200.125%20C%208.859375%200.125%209.140625%200.09375%209.375%200.09375%20L%2011.046875%200.09375%20C%2011.296875%200.09375%2011.59375%200.125%2011.828125%200.125%20C%2011.828125%200.125%2011.828125%200.125%2011.84375%200.125%20C%2012.109375%200.125%2012.234375%20-0.015625%2012.234375%20-0.265625%20Z%20M%2012.234375%20-0.265625%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-2%22%3E%3Cpath%20d%3D%22M%208.4375%20-3.21875%20C%208.4375%20-2.96875%208.390625%20-2.703125%208.3125%20-2.453125%20C%207.9375%20-1.390625%206.90625%20-0.53125%205.5625%20-0.53125%20L%203.65625%20-0.53125%20C%203.546875%20-0.53125%203.296875%20-0.53125%203.296875%20-0.578125%20C%203.296875%20-0.65625%203.328125%20-0.78125%203.359375%20-0.859375%20L%204.328125%20-4.765625%20L%206.890625%20-4.765625%20C%207.875%20-4.765625%208.4375%20-4.15625%208.4375%20-3.21875%20Z%20M%202.875%20-9.40625%20C%202.875%20-9.171875%203.09375%20-9.140625%203.328125%20-9.140625%20C%203.34375%20-9.140625%203.34375%20-9.140625%203.34375%20-9.140625%20C%203.59375%20-9.140625%204.078125%20-9.171875%204.078125%20-9%20C%204.078125%20-8.90625%204.0625%20-8.828125%204.03125%20-8.703125%20L%202.109375%20-1.0625%20C%202.09375%20-0.984375%202.0625%20-0.921875%202.0625%20-0.84375%20C%201.9375%20-0.515625%201.578125%20-0.53125%201.09375%20-0.53125%20C%201.09375%20-0.53125%201.078125%20-0.53125%201.078125%20-0.53125%20C%200.75%20-0.53125%200.546875%20-0.484375%200.546875%20-0.15625%20C%200.546875%200.109375%200.75%200.125%201.015625%200.125%20L%205.90625%200.125%20C%207.421875%200.125%208.671875%20-0.65625%209.34375%20-1.578125%20C%209.640625%20-1.96875%209.875%20-2.453125%209.875%20-3.078125%20C%209.875%20-4.203125%209.0625%20-4.8125%208.171875%20-5.078125%20C%208.5625%20-5.203125%208.921875%20-5.359375%209.234375%20-5.5625%20C%209.921875%20-6%2010.65625%20-6.71875%2010.65625%20-7.71875%20C%2010.65625%20-7.921875%2010.625%20-8.109375%2010.578125%20-8.296875%20C%2010.265625%20-9.265625%209.25%20-9.8125%207.953125%20-9.8125%20L%203.390625%20-9.8125%20C%203.0625%20-9.8125%202.875%20-9.734375%202.875%20-9.40625%20Z%20M%209.234375%20-7.78125%20C%209.234375%20-7.171875%208.953125%20-6.6875%208.625%20-6.3125%20C%208.15625%20-5.75%207.375%20-5.296875%206.34375%20-5.296875%20L%204.484375%20-5.296875%20L%205.3125%20-8.6875%20C%205.34375%20-8.8125%205.375%20-8.921875%205.40625%20-8.96875%20C%205.46875%20-9.171875%205.640625%20-9.140625%205.921875%20-9.140625%20L%207.765625%20-9.140625%20C%208.6875%20-9.140625%209.234375%20-8.640625%209.234375%20-7.78125%20Z%20M%209.234375%20-7.78125%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-3%22%3E%3Cpath%20d%3D%22M%205.71875%20-4.609375%20C%205.71875%20-4.484375%205.71875%20-4.328125%205.6875%20-4.125%20C%205.5625%20-3.28125%205.296875%20-2.3125%204.984375%20-1.640625%20C%204.796875%20-1.234375%204.515625%20-0.84375%204.203125%20-0.59375%20C%204%20-0.421875%203.765625%20-0.265625%203.4375%20-0.265625%20C%202.8125%20-0.265625%202.515625%20-0.859375%202.453125%20-1.421875%20C%202.453125%20-1.46875%202.484375%20-1.5625%202.5%20-1.609375%20L%203.1875%20-4.390625%20C%203.28125%20-4.765625%203.640625%20-5.125%203.875%20-5.328125%20C%204.0625%20-5.515625%204.5%20-5.84375%204.953125%20-5.84375%20C%205.546875%20-5.84375%205.71875%20-5.21875%205.71875%20-4.609375%20Z%20M%201.90625%20-6.375%20C%200.9375%20-6.375%200.65625%20-5.359375%200.4375%20-4.5625%20C%200.375%20-4.375%200.328125%20-4.25%200.328125%20-4.078125%20C%200.328125%20-3.921875%200.453125%20-3.828125%200.609375%20-3.828125%20C%200.875%20-3.828125%200.890625%20-4.03125%200.953125%20-4.265625%20C%201.0625%20-4.6875%201.171875%20-5.140625%201.375%20-5.484375%20C%201.484375%20-5.65625%201.609375%20-5.84375%201.875%20-5.84375%20C%202.15625%20-5.84375%202.1875%20-5.59375%202.1875%20-5.3125%20C%202.1875%20-5.015625%202.140625%20-4.84375%202.078125%20-4.609375%20L%200.484375%201.765625%20C%200.453125%201.875%200.4375%201.953125%200.40625%202.015625%20C%200.34375%202.203125%200.171875%202.203125%20-0.125%202.203125%20C%20-0.125%202.203125%20-0.140625%202.203125%20-0.140625%202.203125%20C%20-0.421875%202.203125%20-0.5625%202.328125%20-0.5625%202.609375%20C%20-0.5625%202.75%20-0.4375%202.875%20-0.265625%202.875%20C%20-0.078125%202.875%200.109375%202.84375%200.296875%202.84375%20L%200.90625%202.84375%20L%202.21875%202.875%20C%202.484375%202.875%202.609375%202.75%202.609375%202.5%20C%202.609375%202.234375%202.421875%202.203125%202.171875%202.203125%20C%202.15625%202.203125%202.15625%202.203125%202.140625%202.203125%20C%201.9375%202.203125%201.578125%202.203125%201.578125%202.125%20C%201.578125%202.125%201.578125%202.125%201.578125%202.109375%20C%201.6875%201.375%202.046875%200.21875%202.203125%20-0.453125%20C%202.4375%20-0.078125%202.8125%200.265625%203.4375%200.265625%20C%203.78125%200.265625%204.125%200.1875%204.453125%200.03125%20C%204.859375%20-0.15625%205.25%20-0.453125%205.578125%20-0.828125%20C%206.28125%20-1.5625%206.90625%20-2.671875%206.90625%20-4.03125%20C%206.90625%20-4.484375%206.8125%20-4.890625%206.65625%20-5.234375%20C%206.375%20-5.859375%205.859375%20-6.375%204.96875%20-6.375%20C%204.78125%20-6.375%204.59375%20-6.328125%204.421875%20-6.28125%20C%203.921875%20-6.109375%203.515625%20-5.765625%203.21875%20-5.4375%20C%203.03125%20-5.96875%202.5625%20-6.375%201.90625%20-6.375%20Z%20M%201.90625%20-6.375%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-1-0%22%3E%3Cpath%20d%3D%22M%209.375%20-3.953125%20L%201.625%20-3.953125%20C%201.296875%20-3.953125%201.046875%20-3.890625%201.046875%20-3.546875%20C%201.046875%20-3.203125%201.296875%20-3.125%201.625%20-3.125%20L%209.375%20-3.125%20C%209.703125%20-3.125%209.96875%20-3.203125%209.96875%20-3.546875%20C%209.96875%20-3.890625%209.703125%20-3.953125%209.375%20-3.953125%20Z%20M%209.375%20-3.953125%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-2-0%22%3E%3Cpath%20d%3D%22M%209.578125%20-3.921875%20L%205.78125%20-3.921875%20L%205.78125%20-7.71875%20C%205.78125%20-8.015625%205.71875%20-8.296875%205.40625%20-8.296875%20C%205.078125%20-8.296875%205%20-8.03125%205%20-7.71875%20L%205%20-3.921875%20L%201.21875%20-3.921875%20C%200.90625%20-3.921875%200.640625%20-3.875%200.640625%20-3.546875%20C%200.640625%20-3.21875%200.890625%20-3.140625%201.203125%20-3.140625%20L%205%20-3.140625%20L%205%200.65625%20C%205%200.953125%205.0625%201.21875%205.390625%201.21875%20C%205.71875%201.21875%205.78125%200.96875%205.78125%200.65625%20L%205.78125%20-3.140625%20L%209.578125%20-3.140625%20C%209.875%20-3.140625%2010.140625%20-3.203125%2010.140625%20-3.53125%20C%2010.140625%20-3.859375%209.890625%20-3.921875%209.578125%20-3.921875%20Z%20M%209.578125%20-3.921875%20%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fdefs%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20-0.000123514%20-14.171477%20L%20283.468574%20-14.171477%20L%20283.468574%2014.174207%20L%20-0.000123514%2014.174207%20Z%20M%20-0.000123514%20-14.171477%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-dasharray%3D%222.98883%202.98883%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20283.468574%20-14.171477%20L%20396.855263%20-14.171477%20L%20396.855263%2014.174207%20L%20283.468574%2014.174207%20Z%20M%20283.468574%20-14.171477%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill-rule%3D%22nonzero%22%20fill%3D%22rgb%2875%25%2C%2075%25%2C%2075%25%29%22%20fill-opacity%3D%221%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20226.773254%20-14.171477%20L%20283.468574%20-14.171477%20L%20283.468574%2014.174207%20L%20226.773254%2014.174207%20Z%20M%20226.773254%20-14.171477%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%220.79701%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20340.159942%200.00136512%20L%20257.711627%200.00136512%20%22%20transform%3D%22matrix%280.988356%2C%200%2C%200%2C%20-0.988356%2C%2026.55481%2C%2014.599005%29%22%2F%3E%3Cpath%20fill-rule%3D%22nonzero%22%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%20d%3D%22M%20278.707031%2014.597656%20L%20282.800781%2016.648438%20L%20281.265625%2014.597656%20L%20282.800781%2012.550781%20%22%2F%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22302.574947%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%226.290548%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-1-0%22%20x%3D%2217.726034%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-1%22%20x%3D%2231.90235%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22400.458754%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-2-0%22%20x%3D%22411.89424%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-2%22%20x%3D%22425.840854%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22234.393213%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-1-0%22%20x%3D%22245.828699%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-3%22%20x%3D%22260.005016%22%20y%3D%2251.02091%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E" class="tikzpicture" />
</div></li>
<li><p><strong>Forwards:</strong> One thread <span class="math inline">x \in [0, B)</span> at a time, calculate the
value for thread <span class="math inline">x</span> then announce that value forwards to all the
threads <span class="math inline">&gt; x</span>, to cover the cases missed by the backwards phase.</p>
<div class="figure">
<!--\tikzstyle{Interval} = [
  draw, anchor=west,
  inner sep=0,
  outer sep=0,
  minimum height=1cm,
  text=black,
  very thick
]
\node[Interval, minimum width=10cm] (first) {};
\node[Interval, minimum width=2cm, right=0cm of first] (second) {};
\node[Interval, minimum width=2cm, right=0cm of second, dashed] (prev) at (second.east) {};
\draw[-stealth, thick] (prev.center) to (second.east);
\node[below=0.8cm of first.south east, anchor=base] {$n$};
\node[below=0.8cm of first.south west, anchor=base] {$n - M$};
\node[below=0.8cm of prev.south east, anchor=base] {$n + B$};
\node[below=0.8cm of prev.south west, anchor=base] {$n + x$};-->
<img src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20width%3D%22443.698pt%22%20height%3D%2256.718pt%22%20viewBox%3D%220%200%20443.698%2056.718%22%3E%3Cdefs%3E%3Cg%3E%3Cg%20id%3D%22glyph-0-0%22%3E%3Cpath%20d%3D%22M%207.78125%20-2.296875%20C%207.53125%20-2.296875%207.5%20-2.109375%207.4375%20-1.921875%20C%207.328125%20-1.5%207.1875%20-1.15625%207.015625%20-0.90625%20C%206.828125%20-0.578125%206.5625%20-0.265625%206.140625%20-0.265625%20C%205.921875%20-0.265625%205.890625%20-0.390625%205.890625%20-0.609375%20C%205.890625%20-0.921875%206.0625%20-1.34375%206.125%20-1.5625%20C%206.328125%20-2.078125%206.5625%20-2.734375%206.765625%20-3.4375%20C%206.890625%20-3.875%207.03125%20-4.3125%207.03125%20-4.796875%20C%207.03125%20-5.828125%206.375%20-6.421875%205.3125%20-6.421875%20C%204.3125%20-6.421875%203.640625%20-5.90625%203.203125%20-5.375%20C%203.0625%20-5.96875%202.5625%20-6.421875%201.859375%20-6.421875%20C%200.890625%20-6.421875%200.578125%20-5.390625%200.375%20-4.59375%20C%200.3125%20-4.40625%200.25%20-4.28125%200.25%20-4.109375%20C%200.25%20-3.953125%200.390625%20-3.859375%200.546875%20-3.859375%20C%200.8125%20-3.859375%200.828125%20-4.0625%200.890625%20-4.296875%20C%201%20-4.734375%201.109375%20-5.203125%201.328125%20-5.53125%20C%201.421875%20-5.71875%201.5625%20-5.890625%201.8125%20-5.890625%20C%202.09375%20-5.890625%202.125%20-5.640625%202.125%20-5.359375%20C%202.125%20-4.90625%201.984375%20-4.484375%201.890625%20-4.0625%20C%201.65625%20-3.171875%201.421875%20-2.265625%201.203125%20-1.359375%20C%201.140625%20-1.15625%201.078125%20-0.859375%201.015625%20-0.609375%20C%200.984375%20-0.453125%200.9375%20-0.359375%200.9375%20-0.21875%20C%200.9375%200.0625%201.15625%200.265625%201.4375%200.265625%20C%201.765625%200.265625%202%200.0625%202.078125%20-0.21875%20C%202.453125%20-1.5%202.734375%20-2.84375%203.078125%20-4.140625%20C%203.390625%20-4.9375%204.203125%20-5.890625%205.265625%20-5.890625%20C%205.765625%20-5.890625%205.90625%20-5.515625%205.90625%20-5.015625%20C%205.90625%20-4.875%205.890625%20-4.6875%205.859375%20-4.46875%20C%205.703125%20-3.609375%205.28125%20-2.453125%205.0625%20-1.84375%20C%204.921875%20-1.515625%204.84375%20-1.296875%204.84375%20-1.015625%20C%204.84375%20-0.28125%205.34375%200.265625%206.09375%200.265625%20C%206.375%200.265625%206.609375%200.1875%206.828125%200.0625%20C%207.34375%20-0.25%207.703125%20-0.90625%207.90625%20-1.5%20C%207.984375%20-1.71875%208.046875%20-1.84375%208.046875%20-2.046875%20C%208.046875%20-2.203125%207.921875%20-2.296875%207.78125%20-2.296875%20Z%20M%207.78125%20-2.296875%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-1%22%3E%3Cpath%20d%3D%22M%2012.328125%20-0.265625%20C%2012.328125%20-0.515625%2012.109375%20-0.546875%2011.875%20-0.546875%20C%2011.859375%20-0.546875%2011.859375%20-0.546875%2011.859375%20-0.546875%20C%2011.609375%20-0.546875%2011.109375%20-0.515625%2011.109375%20-0.671875%20C%2011.109375%20-0.734375%2011.125%20-0.8125%2011.140625%20-0.875%20L%2013.09375%20-8.6875%20C%2013.109375%20-8.765625%2013.140625%20-8.84375%2013.15625%20-8.890625%20C%2013.28125%20-9.25%2013.65625%20-9.21875%2014.140625%20-9.21875%20C%2014.140625%20-9.21875%2014.15625%20-9.21875%2014.15625%20-9.21875%20C%2014.484375%20-9.21875%2014.671875%20-9.28125%2014.671875%20-9.609375%20C%2014.671875%20-9.875%2014.453125%20-9.875%2014.203125%20-9.875%20L%2012.453125%20-9.875%20C%2012.078125%20-9.875%2011.953125%20-9.8125%2011.8125%20-9.578125%20L%206.796875%20-1.640625%20L%205.765625%20-9.453125%20C%205.734375%20-9.8125%205.609375%20-9.875%205.234375%20-9.875%20L%203.421875%20-9.875%20C%203.09375%20-9.875%202.90625%20-9.8125%202.90625%20-9.484375%20C%202.90625%20-9.234375%203.125%20-9.21875%203.375%20-9.21875%20C%203.390625%20-9.21875%203.390625%20-9.21875%203.390625%20-9.21875%20C%203.640625%20-9.21875%204.125%20-9.234375%204.125%20-9.0625%20C%204.125%20-8.96875%204.109375%20-8.890625%204.0625%20-8.765625%20L%202.234375%20-1.484375%20C%202.078125%20-0.8125%201.71875%20-0.578125%200.90625%20-0.546875%20C%200.703125%20-0.546875%200.578125%20-0.390625%200.578125%20-0.15625%20C%200.578125%200.03125%200.703125%200.125%200.890625%200.125%20L%202.1875%200.09375%20L%202.875%200.09375%20C%203.078125%200.09375%203.3125%200.125%203.515625%200.125%20C%203.765625%200.125%203.90625%20-0.015625%203.90625%20-0.265625%20C%203.90625%20-0.453125%203.734375%20-0.546875%203.578125%20-0.546875%20C%203.15625%20-0.5625%202.765625%20-0.59375%202.765625%20-1.03125%20C%202.765625%20-1.203125%202.765625%20-1.171875%202.828125%20-1.359375%20L%204.640625%20-8.609375%20L%205.734375%20-0.375%20C%205.765625%20-0.109375%205.78125%200.125%206.0625%200.125%20C%206.28125%200.125%206.390625%20-0.03125%206.46875%20-0.171875%20L%2011.796875%20-8.609375%20L%209.90625%20-1.078125%20C%209.890625%20-1%209.875%20-0.921875%209.859375%20-0.859375%20C%209.734375%20-0.515625%209.375%20-0.546875%208.890625%20-0.546875%20C%208.890625%20-0.546875%208.875%20-0.546875%208.875%20-0.546875%20C%208.546875%20-0.546875%208.34375%20-0.484375%208.34375%20-0.15625%20C%208.34375%200.046875%208.46875%200.125%208.6875%200.125%20C%208.921875%200.125%209.21875%200.09375%209.453125%200.09375%20L%2011.140625%200.09375%20C%2011.375%200.09375%2011.6875%200.125%2011.921875%200.125%20C%2011.921875%200.125%2011.921875%200.125%2011.9375%200.125%20C%2012.203125%200.125%2012.328125%20-0.015625%2012.328125%20-0.265625%20Z%20M%2012.328125%20-0.265625%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-2%22%3E%3Cpath%20d%3D%22M%208.5%20-3.234375%20C%208.5%20-2.984375%208.453125%20-2.734375%208.375%20-2.46875%20C%208%20-1.40625%206.953125%20-0.546875%205.609375%20-0.546875%20L%203.6875%20-0.546875%20C%203.578125%20-0.546875%203.328125%20-0.53125%203.328125%20-0.578125%20C%203.328125%20-0.65625%203.359375%20-0.78125%203.390625%20-0.875%20L%204.359375%20-4.796875%20L%206.9375%20-4.796875%20C%207.9375%20-4.796875%208.5%20-4.1875%208.5%20-3.234375%20Z%20M%202.90625%20-9.484375%20C%202.90625%20-9.234375%203.109375%20-9.21875%203.359375%20-9.21875%20C%203.375%20-9.21875%203.375%20-9.21875%203.375%20-9.21875%20C%203.625%20-9.21875%204.109375%20-9.234375%204.109375%20-9.0625%20C%204.109375%20-8.96875%204.09375%20-8.890625%204.0625%20-8.765625%20L%202.125%20-1.078125%20C%202.109375%20-1%202.078125%20-0.921875%202.078125%20-0.859375%20C%201.953125%20-0.515625%201.578125%20-0.546875%201.09375%20-0.546875%20C%201.09375%20-0.546875%201.078125%20-0.546875%201.078125%20-0.546875%20C%200.75%20-0.546875%200.5625%20-0.484375%200.5625%20-0.15625%20C%200.5625%200.109375%200.75%200.125%201.03125%200.125%20L%205.953125%200.125%20C%207.484375%200.125%208.734375%20-0.65625%209.40625%20-1.578125%20C%209.71875%20-1.984375%209.953125%20-2.46875%209.953125%20-3.09375%20C%209.953125%20-4.234375%209.140625%20-4.859375%208.234375%20-5.109375%20C%208.625%20-5.234375%208.984375%20-5.390625%209.3125%20-5.609375%20C%2010%20-6.046875%2010.734375%20-6.765625%2010.734375%20-7.78125%20C%2010.734375%20-7.984375%2010.71875%20-8.171875%2010.65625%20-8.359375%20C%2010.34375%20-9.34375%209.328125%20-9.875%208.015625%20-9.875%20L%203.40625%20-9.875%20C%203.078125%20-9.875%202.90625%20-9.8125%202.90625%20-9.484375%20Z%20M%209.3125%20-7.84375%20C%209.3125%20-7.21875%209.03125%20-6.734375%208.703125%20-6.359375%20C%208.21875%20-5.796875%207.421875%20-5.34375%206.390625%20-5.34375%20L%204.515625%20-5.34375%20L%205.359375%20-8.75%20C%205.390625%20-8.890625%205.40625%20-8.984375%205.4375%20-9.046875%20C%205.515625%20-9.234375%205.6875%20-9.21875%205.96875%20-9.21875%20L%207.828125%20-9.21875%20C%208.75%20-9.21875%209.3125%20-8.71875%209.3125%20-7.84375%20Z%20M%209.3125%20-7.84375%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-0-3%22%3E%3Cpath%20d%3D%22M%206.71875%20-2.296875%20C%206.515625%20-2.296875%206.453125%20-2.171875%206.390625%20-2.03125%20C%206.15625%20-1.21875%205.71875%20-0.703125%205.28125%20-0.453125%20C%205.0625%20-0.328125%204.859375%20-0.265625%204.671875%20-0.265625%20C%204.203125%20-0.265625%204.03125%20-0.625%204.03125%20-1.09375%20C%204.03125%20-1.671875%204.15625%20-1.90625%204.3125%20-2.5625%20L%204.8125%20-4.5%20C%204.890625%20-4.796875%205%20-5.0625%205.140625%20-5.296875%20C%205.328125%20-5.59375%205.578125%20-5.890625%206.046875%20-5.890625%20C%206.15625%20-5.890625%206.3125%20-5.859375%206.40625%20-5.828125%20C%206.203125%20-5.703125%206.015625%20-5.421875%206.015625%20-5.125%20C%206.015625%20-4.765625%206.25%20-4.546875%206.609375%20-4.546875%20C%207.109375%20-4.546875%207.46875%20-4.9375%207.46875%20-5.421875%20C%207.46875%20-6.125%206.734375%20-6.421875%206.0625%20-6.421875%20C%205.328125%20-6.421875%204.875%20-5.921875%204.578125%20-5.46875%20C%204.34375%20-6.03125%203.796875%20-6.421875%203.09375%20-6.421875%20C%201.984375%20-6.421875%201.234375%20-5.421875%200.90625%20-4.625%20C%200.8125%20-4.4375%200.75%20-4.3125%200.75%20-4.109375%20C%200.75%20-3.953125%200.875%20-3.859375%201.03125%20-3.859375%20C%201.1875%20-3.859375%201.28125%20-3.96875%201.328125%20-4.078125%20C%201.53125%20-4.765625%201.828125%20-5.203125%202.125%20-5.46875%20C%202.375%20-5.6875%202.703125%20-5.890625%203.0625%20-5.890625%20C%203.515625%20-5.890625%203.703125%20-5.515625%203.703125%20-5.0625%20C%203.703125%20-4.59375%203.578125%20-4.28125%203.4375%20-3.765625%20L%202.953125%20-1.8125%20C%202.890625%20-1.5%202.78125%20-1.21875%202.640625%20-0.953125%20C%202.40625%20-0.5%202.03125%20-0.125%201.3125%20-0.3125%20C%201.546875%20-0.453125%201.734375%20-0.703125%201.734375%20-1.03125%20C%201.734375%20-1.390625%201.453125%20-1.609375%201.109375%20-1.609375%20C%200.625%20-1.609375%200.265625%20-1.21875%200.265625%20-0.734375%20C%200.265625%20-0.015625%200.984375%200.265625%201.6875%200.265625%20C%202.40625%200.265625%202.84375%20-0.21875%203.125%20-0.671875%20C%203.375%20-0.140625%203.90625%200.265625%204.625%200.265625%20C%205.734375%200.265625%206.5%20-0.734375%206.828125%20-1.53125%20C%206.90625%20-1.71875%206.984375%20-1.84375%206.984375%20-2.046875%20C%206.984375%20-2.203125%206.859375%20-2.296875%206.71875%20-2.296875%20Z%20M%206.71875%20-2.296875%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-1-0%22%3E%3Cpath%20d%3D%22M%209.453125%20-3.984375%20L%201.640625%20-3.984375%20C%201.3125%20-3.984375%201.0625%20-3.90625%201.0625%20-3.578125%20C%201.0625%20-3.234375%201.3125%20-3.15625%201.640625%20-3.15625%20L%209.453125%20-3.15625%20C%209.78125%20-3.15625%2010.046875%20-3.234375%2010.046875%20-3.578125%20C%2010.046875%20-3.90625%209.78125%20-3.984375%209.453125%20-3.984375%20Z%20M%209.453125%20-3.984375%20%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22glyph-2-0%22%3E%3Cpath%20d%3D%22M%209.65625%20-3.953125%20L%205.828125%20-3.953125%20L%205.828125%20-7.78125%20C%205.828125%20-8.078125%205.765625%20-8.359375%205.4375%20-8.359375%20C%205.109375%20-8.359375%205.046875%20-8.09375%205.046875%20-7.78125%20L%205.046875%20-3.953125%20L%201.234375%20-3.953125%20C%200.90625%20-3.953125%200.640625%20-3.90625%200.640625%20-3.578125%20C%200.640625%20-3.234375%200.90625%20-3.171875%201.21875%20-3.171875%20L%205.046875%20-3.171875%20L%205.046875%200.65625%20C%205.046875%200.953125%205.09375%201.234375%205.421875%201.234375%20C%205.75%201.234375%205.828125%200.96875%205.828125%200.65625%20L%205.828125%20-3.171875%20L%209.65625%20-3.171875%20C%209.953125%20-3.171875%2010.21875%20-3.234375%2010.21875%20-3.5625%20C%2010.21875%20-3.890625%209.96875%20-3.953125%209.65625%20-3.953125%20Z%20M%209.65625%20-3.953125%20%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fdefs%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20-0.00111201%20-14.173978%20L%20283.467719%20-14.173978%20L%20283.467719%2014.173298%20L%20-0.00111201%2014.173298%20Z%20M%20-0.00111201%20-14.173978%20%22%20transform%3D%22matrix%280.995053%2C%200%2C%200%2C%20-0.995053%2C%2025.231575%2C%2014.696927%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20283.467719%20-14.173978%20L%20340.16227%20-14.173978%20L%20340.16227%2014.173298%20L%20283.467719%2014.173298%20Z%20M%20283.467719%20-14.173978%20%22%20transform%3D%22matrix%280.995053%2C%200%2C%200%2C%20-0.995053%2C%2025.231575%2C%2014.696927%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%221.19553%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-dasharray%3D%222.98883%202.98883%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20340.16227%20-14.173978%20L%20396.856822%20-14.173978%20L%20396.856822%2014.173298%20L%20340.16227%2014.173298%20Z%20M%20340.16227%20-14.173978%20%22%20transform%3D%22matrix%280.995053%2C%200%2C%200%2C%20-0.995053%2C%2025.231575%2C%2014.696927%29%22%2F%3E%3Cpath%20fill%3D%22none%22%20stroke-width%3D%220.79701%22%20stroke-linecap%3D%22butt%22%20stroke-linejoin%3D%22miter%22%20stroke%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20stroke-opacity%3D%221%22%20stroke-miterlimit%3D%2210%22%20d%3D%22M%20368.509546%200.0016229%20L%20342.753214%200.0016229%20%22%20transform%3D%22matrix%280.995053%2C%200%2C%200%2C%20-0.995053%2C%2025.231575%2C%2014.696927%29%22%2F%3E%3Cpath%20fill-rule%3D%22nonzero%22%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%20d%3D%22M%20363.710938%2014.695312%20L%20367.835938%2016.757812%20L%20366.289062%2014.695312%20L%20367.835938%2012.636719%20%22%2F%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22303.121914%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%224.829016%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-1-0%22%20x%3D%2216.341984%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-1%22%20x%3D%2230.614353%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22401.668941%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-2-0%22%20x%3D%22413.181909%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-2%22%20x%3D%22427.22302%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-0%22%20x%3D%22346.954977%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-2-0%22%20x%3D%22358.467945%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22rgb%2813.331604%25%2C%2013.331604%25%2C%2013.331604%25%29%22%20fill-opacity%3D%221%22%3E%3Cuse%20xlink%3Ahref%3D%22%23glyph-0-3%22%20x%3D%22372.509056%22%20y%3D%2251.365612%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E" class="tikzpicture" />
</div></li>
</ol>
<p>Here’s how this looks in code.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The position and value of all (known) rare values</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">unsigned</span> RARE_VALUE_COUNT <span class="op">=</span> <span class="dv">1584</span><span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>__constant__ <span class="dt">uint16_t</span> rare_positions<span class="op">[</span>RARE_VALUE_COUNT<span class="op">];</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>__constant__ <span class="dt">uint8_t</span> rare_values<span class="op">[</span>RARE_VALUE_COUNT<span class="op">];</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">// The first BLOCK_SIZE values, with common values marked by 0xFF</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">unsigned</span> BLOCK_SIZE <span class="op">=</span> <span class="dv">256</span><span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>__constant__ <span class="dt">uint32_t</span> low_rare<span class="op">[</span>BLOCK_SIZE<span class="op">];</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialised with the first SHARED_BUFFER_SIZE positions</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>__shared__ <span class="dt">uint8_t</span> buffer<span class="op">[</span>SHARED_BUFFER_SIZE<span class="op">];</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> mex_array<span class="op">[</span><span class="dv">256</span> <span class="op">/</span> <span class="dv">32</span><span class="op">]</span> <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">// The Backward phase:</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> rare_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> rare_idx <span class="op">&lt;</span> RARE_VALUE_COUNT<span class="op">;</span> rare_idx<span class="op">++)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> rare_pos <span class="op">=</span> rare_positions<span class="op">[</span>rare_idx<span class="op">];</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> rare_value <span class="op">=</span> rare_values<span class="op">[</span>rare_idx<span class="op">];</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">&lt;</span> rare_pos<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> prev <span class="op">=</span> buffer<span class="op">[(</span>position <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_pos<span class="op">)</span> <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">];</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> option <span class="op">=</span> prev <span class="op">^</span> rare_value<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    set_bit<span class="op">(</span>mex_array<span class="op">,</span> option<span class="op">);</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">// The Forward phase:</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> done_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> done_idx <span class="op">&lt;</span> BLOCK_SIZE<span class="op">;</span> done_idx<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If it's our turn, calculate the MEX</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  __shared__ <span class="dt">uint8_t</span> final_value<span class="op">;</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">==</span> done_idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    final_value <span class="op">=</span> lowest_unset<span class="op">(</span>mex_array<span class="op">);</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">[</span>position <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> final_value<span class="op">;</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  __syncthreads<span class="op">();</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Communicate this value to threads computing later positions</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">&gt;</span> done_idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> rare_value <span class="op">=</span> low_rare<span class="op">[</span>threadIdx<span class="op">.</span>x <span class="op">-</span> done_idx <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rare_value <span class="op">!=</span> <span class="bn">0xFF</span><span class="op">)</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      set_bit<span class="op">(</span>mex_array<span class="op">,</span> final_value <span class="op">^</span> rare_value<span class="op">);</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  __syncthreads<span class="op">();</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>With 256 threads this goes at about 470K/s, which is a nice
improvement.</p>
<h2 id="tracking-the-mex-in-a-thread">Tracking the MEX in a Thread</h2>
<p>Above we used some functions <code>set_bit</code> and <code>lowest_unset</code>, how do we
implement those operations efficiently? Because each value fits into a
byte, we will have each thread keep track of the values it has seen by
storing a 256-bit mask, and setting single bits as we go.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> set_bit<span class="op">(</span><span class="dt">uint32_t</span> array<span class="op">[</span><span class="dv">8</span><span class="op">],</span> <span class="at">const</span> <span class="dt">unsigned</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">__builtin_assume</span><span class="op">(</span>i <span class="op">&lt;</span> <span class="op">(</span><span class="dv">1</span><span class="bu">u</span><span class="op">&lt;&lt;</span><span class="dv">8</span><span class="op">));</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  array<span class="op">[</span>i<span class="op">/</span><span class="dv">32</span><span class="op">]</span> <span class="op">|=</span> <span class="dv">1</span><span class="bu">u</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Because the index <code>array[i/32]</code> is not a compile-time constant,
there’s a risk that this <code>array</code> will end up in local memory rather
than in registers if the compiler can’t figure out this can be written
as an unrolled loop.<span class="sidenote-wrapper"><label for="sn-10" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-10" class="margin-toggle" /><span class="sidenote">Despite the name, local memory is actually a
thread-specific piece of <em>global</em> memory. It’s where, for example,
spilled registers get stored.<br />
<br />
</span></span> For reasons mysterious to me, sometimes
the compiler can do this and sometimes not. Just in case, we’ll do the
optimisation by hand.</p>
<p>We can manually write the operation as a loop:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma unroll 8</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>j <span class="op">==</span> i<span class="op">/</span><span class="dv">32</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    array<span class="op">[</span>j<span class="op">]</span> <span class="op">|=</span> <span class="dv">1</span><span class="bu">u</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This compiles to a straight-line program, using predicated
instructions to operate on the correct entry of the array.</p>
<p>Here’s a alternative trick which comes out slightly ahead and, for
reasons again mysterious to me, seems to cause less register pressure.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma unroll 8</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  array<span class="op">[</span>j<span class="op">]</span> <span class="op">|=</span> __funnelshift_lc<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> i <span class="op">-</span> <span class="op">(</span><span class="dv">32</span> <span class="op">*</span> j<span class="op">));</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We use a “clamped funnel shift” to produce the correct mask for each
array entry directly. For this operation, shifting by more than 32 is
clamped to a shift of exactly 32 rather than wrapping around back to
zero. So, for an array entry <code>j</code> that is too small, the 0 value is
fully shifted into the result. And when <code>j</code> is too large, the shift
distance underflows and again the 0 is fully shifted in.</p>
<p>At the end of the main loop, the MEX can be computed from the mask by
using the <code>__ffs</code> (“find first set”) intrinsic to pick out the first 0
bit.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> lowest_unset<span class="op">(</span><span class="dt">uint32_t</span> array<span class="op">[</span><span class="dv">8</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">256</span><span class="op">/</span><span class="dv">32</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>array<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> <span class="bn">0xFFFFFFFF</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> bit_pos <span class="op">=</span> __ffs<span class="op">(~</span>array<span class="op">[</span>i<span class="op">])</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// __ffs returns 1-based position</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> i <span class="op">*</span> <span class="dv">32</span> <span class="op">+</span> bit_pos<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">__builtin_unreachable</span><span class="op">();</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>While we’re at it, we’ll can shove the MEX array into a <code>struct</code>
rather than using an array directly, and manually unroll the loop into
8 separate <code>struct</code> members. For reasons unclear to me, this does
cause a slight speed improvement.</p>
<h2 id="multiple-blocks">Multiple Blocks</h2>
<p>Of course, we don’t want to restrict ourselves to only one block: the
GPU has several multiprocessors that can run blocks simultaneously. We
might have <span class="math inline">K</span> blocks going at once, so that block 0 is responsible
for computing the range <span class="math inline">[n, n+B)</span>, block 1 is responsible for the
range <span class="math inline">[n+B, n+2B)</span>, and so on.</p>
<p>We have to modify the backwards phase, because a block may catch up to
values currently being computed by earlier blocks and have to wait for
that to complete. On a step with rare position <span class="math inline">p</span>, the latest
position in the current range, i.e. <span class="math inline">n + B - 1</span>, will need to read
from the buffer at position <span class="math inline">(n + B - 1) - p - 1</span>. We can be certain
other blocks aren’t working on that position as long as it is strictly
less than <span class="math inline">n - B(K-1)</span>. A little rearrangement gives the condition <span class="math inline">p
&lt; B K - 1</span>.</p>
<p>We are safe again as soon as <span class="math inline">p &lt; B-1</span>: all the relevant values are
going to be computed local to the current block in the forward phase.</p>
<p>To make this work, we need to synchronise the blocks somehow. Here I
am going to simply store a value in global memory that records the
overall progress, i.e., up to what position the values are known. Each
thread will also know up to what position its block’s shared buffer is
correct, and if a still-unknown value is needed, we’ll have the block
spin until that value is available.</p>
<p>The backward phase now looks like:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The Backward phase:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> rare_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> rare_idx <span class="op">&lt;</span> RARE_VALUE_COUNT<span class="op">;</span> rare_idx<span class="op">++)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> rare_pos <span class="op">=</span> rare_positions<span class="op">[</span>rare_idx<span class="op">];</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> rare_value <span class="op">=</span> rare_values<span class="op">[</span>rare_idx<span class="op">];</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Test whether we are in the danger zone:</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rare_pos <span class="op">&lt;</span> BLOCK_SIZE <span class="op">*</span> BLOCK_COUNT <span class="op">-</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> rare_pos <span class="op">&gt;</span> BLOCK_SIZE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Until we have the value we need:</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>buffer_correct <span class="op">&lt;=</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>           block_offset <span class="op">+</span> <span class="op">(</span>BLOCK_SIZE <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_pos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait for the next block to be available:</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(*</span>global_progress <span class="op">==</span> buffer_correct<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>      __syncthreads<span class="op">();</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// And copy that block of values in:</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>      buffer<span class="op">[(</span>buffer_correct <span class="op">+</span> threadIdx<span class="op">.</span>x<span class="op">)</span> <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        global_buffer<span class="op">[(</span>buffer_correct <span class="op">+</span> threadIdx<span class="op">.</span>x<span class="op">)</span> <span class="op">%</span> GLOBAL_BUFFER_SIZE<span class="op">];</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>      buffer_correct <span class="op">+=</span> BLOCK_SIZE<span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    __syncthreads<span class="op">();</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Now proceed as before:</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">&lt;</span> rare_pos<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> prev <span class="op">=</span> buffer<span class="op">[(</span>position <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_pos<span class="op">)</span> <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">];</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> option <span class="op">=</span> prev <span class="op">^</span> rare_value<span class="op">;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    set_bit_8<span class="op">(</span>mex_array<span class="op">,</span> option<span class="op">);</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>With 8 blocks of size 256, this does 942K/s. Getting better!</p>
<h2 id="speculating-in-the-forward-phase">Speculating in the Forward Phase</h2>
<p>As observed by Grossman, the speed of the calculation is ultimately
limited by how quickly each block can get through its critical
segment, that is, the part where it computes the MEX. While this is
happening, all other blocks are likely waiting for it to finish. Our
priority now should be to make that forward phase as fast as possible.</p>
<p>Once we’ve completed the backwards phase, we can have each thread
speculate on what its MEX will be given the past values it’s seen so
far. This can be done simultaneously over all threads. Then, we can
use these speculative values to mark the MEX arrays, and recalculate
the MEXes (again simultaneously).<span class="sidenote-wrapper"><label for="sn-11" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-11" class="margin-toggle" /><span class="sidenote">This is so obviously the right
thing to do that it’s embarrassing I didn’t do it to begin with.<br />
<br />
</span></span>
Here’s the trick: if we get the <em>same</em> answer as the first round of
MEXes, then in fact this is the right answer. If our blocks are of
size 256, we’ve replaced 256 sequential MEX calculations and 256
forward broadcasts with 2 parallel MEX calculations and 51 backwards
lookups (the number of rare positions below 256).</p>
<p>If we <em>don’t</em> get the same answer, we simply repeat the process. The
values get monotonically more correct from left to right after each
round, and so this is guaranteed to reach a fixed point. In principle
we could get very unlucky, but most of the time it only takes two or
three rounds.<span class="sidenote-wrapper"><label for="sn-12" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-12" class="margin-toggle" /><span class="sidenote">In a quick test, the chance of a block being done after
<span class="math inline">n</span> rounds was 0%, 10%, 62%, 84%, 96%, 99%.<br />
<br />
</span></span></p>
<p>Because the values within the block are changing, we have to store a
second <code>mex_array</code> for these final values so that it can be easily
reset between rounds.</p>
<p>Here’s how the new forwards phase looks:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Do the first round of speculation using purely the values from </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">// the backwards phase. </span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> prev_mex <span class="op">=</span> lowest_unset<span class="op">(</span>mex_array<span class="op">);</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">[</span>position <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> prev_mex<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>__syncthreads<span class="op">();</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>__shared__ <span class="dt">bool</span> done<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  done <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(!</span>done<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialise a mex array just for these final values</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> intra_mex_array<span class="op">[</span><span class="dv">256</span> <span class="op">/</span> <span class="dv">32</span><span class="op">];</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">256</span> <span class="op">/</span> <span class="dv">32</span><span class="op">;</span> i <span class="op">+=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    intra_mex_array<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Do a backward phase calculation as before but storing the</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// result in this separate array</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> rare_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> rare_idx <span class="op">&lt;</span> LAST_RARES<span class="op">;</span> rare_idx<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> rare_pos <span class="op">=</span> rare_positions_rev<span class="op">[</span>RARE_COUNT <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_idx<span class="op">];</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> rare_value <span class="op">=</span> rare_values_rev<span class="op">[</span>RARE_COUNT <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_idx<span class="op">];</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> prev <span class="op">=</span> buffer<span class="op">[(</span>position <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> rare_pos<span class="op">)</span> <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">];</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> option <span class="op">=</span> prev <span class="op">^</span> rare_value<span class="op">;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    set_bit_8<span class="op">(</span>intra_mex_array<span class="op">,</span> option<span class="op">);</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate the new MEX from the combined arrays</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> total_mex_array<span class="op">[</span><span class="dv">256</span> <span class="op">/</span> <span class="dv">32</span><span class="op">];</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">256</span> <span class="op">/</span> <span class="dv">32</span><span class="op">;</span> i <span class="op">+=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    total_mex_array<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> mex_array<span class="op">[</span>i<span class="op">]</span> <span class="op">|</span> intra_mex_array<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> current_mex <span class="op">=</span> lowest_unset<span class="op">(</span>total_mex_array<span class="op">);</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  buffer<span class="op">[</span>position <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> current_mex<span class="op">;</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If any of the values changed, we have to retry</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>threadIdx<span class="op">.</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    done <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  __syncthreads<span class="op">();</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>current_mex <span class="op">!=</span> prev_mex<span class="op">)</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    done <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  __syncthreads<span class="op">();</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>  prev_mex <span class="op">=</span> current_mex<span class="op">;</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Copy results out</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>global_buffer<span class="op">[</span>position <span class="op">%</span> GLOBAL_BUFFER_SIZE<span class="op">]</span> </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">=</span> buffer<span class="op">[</span>position <span class="op">%</span> SHARED_BUFFER_SIZE<span class="op">];</span></span></code></pre></div>
<p>This modest change gets us 3.6M positions per second, a 4×
improvement. Wow!</p>
<p>Following this reasoning a bit further, it seems reasonable to try and
avoid doing the entire loop over the <code>LAST_RARES</code>, only looping over
the suffix of the values that are still unconfirmed. Unfortunately,
the extra bookkeeping involved makes this slightly slower than just
doing the whole loop every time.<span class="sidenote-wrapper"><label for="sn-13" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-13" class="margin-toggle" /><span class="sidenote">It is extremely demoralising when
this happens, when making the code smarter ends up being a total
waste.<br />
<br />
</span></span></p>
<h2 id="synchronising-properly">Synchronising Properly</h2>
<p>This code works on my machine and with these particular parameters,
but it possibly shouldn’t. The CUDA programming model makes no
guarantees about when blocks get run in relation to each other, so the
strategy I’ve used here of synchronising via a global variable could
deadlock if for some reason one of the blocks never gets scheduled.</p>
<p>As far as I can tell there are three official methods for
synchronising across different blocks, even those that are part of the
same kernel:</p>
<ul>
<li>Wait for all blocks to run to completion then launch a new
computation.</li>
<li>Use <code>cuda::barrier&lt;cuda::thread_scope_device&gt;</code>.</li>
<li>Use the <code>grid.sync()</code> method in the Cooperative Groups library.</li>
</ul>
<p>It would be nice to implement things “properly” and use one of these
methods. The one that fits best is to use <code>cuda::barrier</code>.
Unfortunately, this ends up significantly slower than the cheating
method I’m using now, so I’ll keep that in my back pocket in case
deadlocks become an actual issue. I haven’t tracked down exactly why
this slowdown occurs.</p>
<h2 id="the-state-of-play">The State of Play</h2>
<p>Everything described above is available at
<a href="https://github.com/mvr/officers" class="uri">https://github.com/mvr/officers</a>. At the time of writing it
calculates values at 3.6M/s on my (<a href="https://www.nvidia.com/en-us/autonomous-machines/embedded-systems/jetson-orin/nano-super-developer-kit/">dinky little</a>) machine. This is
pathetic: Grossman’s code gets 5M/s on 8 (CPU) threads, and I’m only
getting 3.6M/s on vastly more (GPU) threads. We should be able to do
better. Clock speed goes some of the way (but not all the way!) to
explaining the speed difference: Grossman was using a 2.66GHz CPU
whereas this GPU runs at 900MHz. The <code>__ffs</code> intrinsic used for
calculating the MEX is also <a href="https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/index.html#arithmetic-instructions">more expensive</a> than you would expect,
with a SM not even able to calculate an entire warp’s worth per cycle.</p>
<p>We’ll need a better strategy. The next idea, and what I’ll leave for
next time, is to scale up speculation to the level of entire blocks,
allowing each block to compute a speculative set of values based on
unconfirmed previous ones. If those unconfirmed previous values turn
out to be correct, the speculative values themselves are also correct.</p>
<p>At worst this would be as fast as the single-block version, because
the earliest unconfirmed block never has to actually do any
speculation. Again, it will have to be determined empirically how many
rounds of speculation each block needs on average before all mistakes
are fixed.</p>
<p>PS. My personal suspicion is that Officers is periodic but with a
pre-period so long that humans will never live to find out what it is.
This is more about the journey than the destination.</p>
<h2 id="references">References</h2>
<ul>
<li>Berlekamp, Elwyn R.; Conway, John H.; Guy, Richard K. <a href="https://www.routledge.com/Winning-Ways-for-Your-Mathematical-Plays-Volume-1/Berlekamp-Conway-Guy/p/book/9781568811307">Winning Ways for Your Mathematical Plays</a>. Vol. 1. Second edition. A K Peters, Ltd., Natick, MA, 2001. xx+276 pp. ISBN: 1-56881-130-6</li>
<li>Caines, Ian; Gates, Carrie; Guy, Richard K.; Nowakowski, Richard J. <a href="https://doi.org/10.2307/2589561">Periods in Taking and Splitting Games</a>. Amer. Math. Monthly 106 (1999), no. 4, 359–361.</li>
<li>Flammenkamp, A. <a href="https://wwwhomes.uni-bielefeld.de/achim/octal.html">Sprague-Grundy Values of Octal-Games</a>. 2021</li>
<li>Gangolli, A.; Plambeck, T. <a href="https://link.springer.com/content/pdf/10.1007/BF01254294.pdf">A Note on Periodicity in Some Octal Games</a>. Internat. J. Game Theory 18 (1989), no. 3, 311–320</li>
<li>Grossman, J. P. <a href="https://library.slmath.org/books/Book70/files/1016.pdf">Searching for periodicity in Officers</a>. Games of No Chance 5, 373–385, Math. Sci. Res. Inst. Publ., 70, Cambridge Univ. Press, Cambridge, 2019.</li>
</ul>
</div>

</section>

        <footer>
          Please <a href="mailto:mitchell.v.riley@gmail.com">email</a> me any comments or suggestions. Site built using <a href="https://jaspervdj.be/hakyll/">Hakyll</a>, source on <a href="https://github.com/mvr/mvr.github.io">Github</a>. <!-- Some design elements cribbed from <a href="https://github.com/coletownsend/balzac-for-jekyll">Cole Townsend</a>. -->
        </footer>

    </body>
</html>
